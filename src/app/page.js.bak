"use client";

import { useState, useEffect, useCallback, useRef } from "react";
import axios from "axios";
import { toast } from "react-hot-toast";
import { Search, MapPin, Wind, Droplets, Sun, CloudRain, Thermometer, Plus, Heart, Trash2, Sunrise, Sunset, Umbrella, Gauge, Zap, CloudFog, LocateFixed, ChevronDown, ArrowRight } from "lucide-react";
import { AreaChart, Area, XAxis, Tooltip, ResponsiveContainer, CartesianGrid } from 'recharts';
import Link from 'next/link';
import Image from 'next/image';
import { AuthModal, ProfileModal } from '@/components/AuthComponents';
import WeatherMap from '@/components/WeatherMap';
import Tilt from '@/components/Tilt';
import DigitalClock from '@/components/DigitalClock';
import Preloader from '@/components/Preloader';
import ScrollReveal from '@/components/ScrollReveal';

const DEFAULT_CITY = "Colombo";

const getWeatherEmoji = (condition) => {
  if (!condition) return "‚òÅÔ∏è";
  const main = condition.toLowerCase();
  if (main.includes('clear')) return "‚òÄÔ∏è";
  if (main.includes('clouds')) return "‚òÅÔ∏è";
  if (main.includes('rain')) return "üåßÔ∏è";
  if (main.includes('drizzle')) return "üå¶Ô∏è";
  if (main.includes('thunderstorm')) return "‚õàÔ∏è";
  if (main.includes('snow')) return "‚ùÑÔ∏è";
  if (main.includes('mist') || main.includes('fog')) return "üå´Ô∏è";
  return "üå§Ô∏è";
};

const CustomXAxisTick = ({ x, y, payload, data, unit }) => {
  const item = data && data[payload.index];
  return (
    <g transform={`translate(${x},${y})`}>
      <text x={0} y={0} dy={16} textAnchor="middle" fill="#9CA3AF" fontSize={12}>
        {payload.value}
      </text>
      <text x={0} y={-25} textAnchor="middle" fontSize={16}>
        {getWeatherEmoji(item?.condition)}
      </text>
      <text x={0} y={-10} textAnchor="middle" fill="#1F2937" fontSize={12} fontWeight="bold">
        {item?.displayTemp}¬∞
      </text>
    </g>
  );
};

export default function Home() {
  const [city, setCity] = useState(DEFAULT_CITY);
  const [weather, setWeather] = useState(null);
  const [forecast, setForecast] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [loading, setLoading] = useState(true);
  const [unit, setUnit] = useState('C');
  const [chartType, setChartType] = useState('temp');

  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const isTyping = useRef(false);

  const [user, setUser] = useState(null);
  const [showAuth, setShowAuth] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [announcement, setAnnouncement] = useState('');

  const getClothingAdvice = (data) => {
    if (!data || !data.weather || !data.weather[0]) return "Enjoy your day!";
    
    const condition = data.weather[0].main.toLowerCase();
    const temp = data.main.temp;

    if (condition.includes('rain') || condition.includes('drizzle') || condition.includes('thunderstorm')) {
      return "Don't forget your umbrella ‚òî";
    }
    if (condition.includes('snow')) {
      return "Wear warm clothes ‚ùÑÔ∏è";
    }
    if (condition.includes('clear') || condition.includes('sun')) {
       if (temp > 25) return "Wear sunglasses üï∂Ô∏è";
       return "It's a beautiful day ‚òÄÔ∏è";
    }
    if (temp < 15) {
      return "It's chilly, wear a jacket üß•";
    }
    if (temp > 30) {
      return "Stay hydrated üíß";
    }
    if (condition.includes('clouds')) {
      return "Good weather for a walk ‚òÅÔ∏è";
    }
    
    return "Have a nice day! üòä";
  };

  useEffect(() => {
    axios.get('/api/auth/me').then(res => {
        if(res.data.user) {
            setUser(res.data.user);
            if(res.data.user.savedCities) setFavorites(res.data.user.savedCities);
        }
    }).catch(() => {});

    axios.get('/api/settings').then(res => {
        if(res.data.announcement) setAnnouncement(res.data.announcement);
    }).catch(()=>{});

  }, []);

  const getTemp = (celsius) => {
    if (unit === 'F') return Math.round(celsius * 9 / 5 + 32);
    return Math.round(celsius);
  };

  const fetchData = useCallback(async (cityName) => {
    try {
      const weatherRes = await axios.get(`/api/weather?city=${cityName}`);
      setWeather(weatherRes.data);
      setCity(weatherRes.data.name);
      isTyping.current = false;

      const forecastRes = await axios.get(`/api/forecast?city=${cityName}`);
      const graphData = forecastRes.data.list.slice(0, 10).map(item => ({
        dt: item.dt,
        rain: item.rain,
        time: new Date(item.dt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        temp: Math.round(item.main.temp),
        pop: item.pop,
        condition: item.weather[0]?.main
      }));
      setForecast(graphData);
    } catch (error) {
      console.error("Error fetching data", error);
      toast.error("Could not fetch weather data. Please try again.");
    }
    setLoading(false);
  }, []);

  const handleLocateMe = () => {
    if (navigator.geolocation) {
      setLoading(true);
      navigator.geolocation.getCurrentPosition(async (position) => {
        const { latitude, longitude } = position.coords;
        try {
          const weatherRes = await axios.get(`/api/weather?lat=${latitude}&lon=${longitude}`);
          setWeather(weatherRes.data);
          setCity(weatherRes.data.name); 

          const forecastRes = await axios.get(`/api/forecast?lat=${latitude}&lon=${longitude}`);
          const graphData = forecastRes.data.list.slice(0, 10).map(item => ({
            dt: item.dt,
            rain: item.rain,
            time: new Date(item.dt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            temp: Math.round(item.main.temp),
            pop: item.pop,
            condition: item.weather[0]?.main
          }));
          setForecast(graphData);
        } catch (error) {
           console.error("Error fetching location data", error);
           toast.error("Failed to fetch weather for your location");
        }
        setLoading(false);
      }, (error) => {
         console.error("Geolocation error", error);
         setLoading(false);
         toast.error("Unable to retrieve your location. Please allow location access.");
      });
    } else {
      toast.error("Geolocation is not supported by this browser.");
    }
  };

  const fetchFavorites = useCallback(async () => {
    try {
      const res = await axios.get('/api/favorites');
      setFavorites(res.data);
    } catch (error) {
      console.error("Error fetching favorites", error);
      if (error.response && error.response.status !== 401) {
         toast.error("Failed to load favorites");
      }
    }
  }, []);

  useEffect(() => {
    fetchData(DEFAULT_CITY);
    if(user) fetchFavorites();
    else fetchFavorites(); 
  }, [fetchData, fetchFavorites, user]);

  useEffect(() => {
     if (user) {
        if(user.preferences?.unit && user.preferences.unit !== unit) setUnit(user.preferences.unit);
        fetchFavorites();
     }
  }, [user, fetchFavorites, unit]);

  useEffect(() => {
    const fetchSuggestions = async () => {
      if (city.length > 2) {
        try {
          const res = await axios.get(`/api/search?q=${city}`);
          const unique = res.data.filter((v, i, a) => a.findIndex(t => (t.name === v.name && t.country === v.country)) === i);
          setSuggestions(unique);
          setShowSuggestions(true);
        } catch (error) {
           console.error("Search error", error);
           toast.error("Error searching for cities");
        }
      } else {
        setSuggestions([]);
        setShowSuggestions(false);
      }
    };

    if (!isTyping.current) return;

    const timeoutId = setTimeout(() => {
        fetchSuggestions();
    }, 500);

    return () => clearTimeout(timeoutId);
  }, [city]);

  const handleSelectSuggestion = (suggestion) => {
    setCity(suggestion.name);
    setSuggestions([]);
    setShowSuggestions(false);
    isTyping.current = false;
    fetchData(suggestion.name);
  };

  const handleSearch = (e) => {
    e.preventDefault();
    fetchData(city);
    setShowSuggestions(false);
  };

  const handleNextCity = () => {
     if (!favorites || favorites.length === 0) return;
     const currentIdx = favorites.findIndex(f => f.name === weather?.name);
     const nextIdx = (currentIdx + 1) % favorites.length;
     fetchData(favorites[nextIdx].name);
  };

  const handlePrevCity = () => {
     if (!favorites || favorites.length === 0) return;
     const currentIdx = favorites.findIndex(f => f.name === weather?.name);
     const prevIdx = (currentIdx - 1 + favorites.length) % favorites.length;
     fetchData(favorites[prevIdx].name);
  };

  const toggleFavorite = async () => {
    if (!user) {
        setShowAuth(true);
        return;
    }
    if (!weather) return;
    
    try {
      const isFavorite = favorites.find(f => f.name === weather.name);

      if (isFavorite) {
        await axios.delete(`/api/favorites?name=${weather.name}`);
        toast.success("Removed from Favorites!");
      } else {
        await axios.post('/api/favorites', { name: weather.name });
        toast.success("Saved to Favorites!");
      }
      fetchFavorites();
    } catch (error) {
      console.error("Error updating favorites", error);
      toast.error("Failed to update favorites");
    }
  };

  if (loading) return <Preloader />;

  const isCurrentFavorite = favorites.some(f => f.name === weather?.name);
  
  const chartData = forecast.map(item => ({
    ...item, 
    displayTemp: getTemp(item.temp), 
    rainChance: (item.pop || 0) * 100 
  }));

  return (
    <div className="min-h-screen bg-[#F6F6F8] font-sans relative">
      
      {announcement && (
        <div className="absolute top-0 left-0 right-0 z-50 bg-gradient-to-r from-purple-600 to-blue-600 text-white text-center py-2 px-4 shadow-lg font-bold flex items-center justify-center gap-2">
           <Zap size={18} className="animate-pulse" /> {announcement}
        </div>
      )}

      <div className={`w-full flex flex-col transition-all ${announcement ? 'mt-8' : ''}`}>
        
        {/* HERO SECTION */}
        <div className="bg-gradient-to-br from-[#4facfe] to-[#00f2fe] dark:from-[#0f2027] dark:to-[#203a43] w-full min-h-screen p-6 md:p-10 text-white flex flex-col justify-between relative overflow-hidden shadow-2xl z-0">
          
          {/* Background Blobs */}
          <div className="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
          <div className="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
          <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>

          <div className="flex justify-between items-center animate-fade-in-up w-full relative z-10">
            <div 
              onClick={() => toggleFavorite()} 
              className="bg-white/20 p-2.5 rounded-full cursor-pointer hover:bg-white/30 transition backdrop-blur-md border border-white/10 shadow-lg group"
              title="Add current city to favorites"
            >
              <Plus size={20} className="group-hover:rotate-90 transition duration-300"/>
            </div>
            
            <div className="flex items-center gap-4">
                <div className="flex gap-2 text-sm font-semibold bg-white/10 px-5 py-2.5 rounded-full backdrop-blur-md border border-white/10 shadow-lg">
                  <span className={`cursor-pointer transition hover:text-white ${unit === 'C' ? 'text-white' : 'text-white/60'}`} onClick={() => setUnit('C')}>¬∞C</span>
                  <span className="opacity-30">|</span>
                  <span className={`cursor-pointer transition hover:text-white ${unit === 'F' ? 'text-white' : 'text-white/60'}`} onClick={() => setUnit('F')}>¬∞F</span>
                </div>

                <div 
                  className="w-11 h-11 bg-white/20 rounded-full overflow-hidden cursor-pointer hover:ring-2 ring-white/50 transition relative backdrop-blur-md shadow-lg"
                  onClick={() => user ? setShowProfile(true) : setShowAuth(true)}
                >
                   {user ? (
                       user.profilePicture ? (
                           <Image 
                             src={user.profilePicture}
                             alt={user.name}
                             fill
                             className="object-cover"
                           />
                       ) : (
                           <div className={`w-full h-full flex items-center justify-center text-sm ${user.gender === 'female' ? 'bg-pink-300' : 'bg-blue-300'}`}>
                               {user.gender === 'female' ? 'üë©' : 'üë®'}
                           </div>
                       )
                   ) : (
                      <Image 
                        src={`https://api.dicebear.com/7.x/avataaars/svg?seed=guest`} 
                        alt="User" 
                        width={44} 
                        height={44} 
                      />
                   )}
                </div>
            </div>
          </div>

          <div className="flex-1 flex flex-col items-center justify-center relative z-20 gap-8 mt-2">
             {/* Sunrise/Sunset */}
             <div className="flex gap-8 text-sm font-medium bg-white/5 px-8 py-5 rounded-[40px] backdrop-blur-xl border border-white/10 shadow-2xl animate-fade-in-up animation-delay-2000 hover:bg-white/10 transition duration-500">
               <div className="flex items-center gap-4">
                 <div className="bg-gradient-to-br from-yellow-400 to-orange-500 p-2.5 rounded-full shadow-lg">
                    <Sunrise size={20} className="text-white" />
                 </div>
                 <div className="flex flex-col leading-none">
                    <span className="text-[10px] text-white/80 uppercase tracking-wider font-bold mb-1">Sunrise</span>
                    <span className="text-lg font-bold tracking-wide">{weather?.sys?.sunrise ? new Date(weather.sys.sunrise * 1000).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit', hour12: false }) : "--:--"}</span>
                 </div>
               </div>
               <div className="w-[1px] h-auto bg-white/10"></div>
               <div className="flex items-center gap-4">
                 <div className="bg-gradient-to-br from-orange-400 to-red-500 p-2.5 rounded-full shadow-lg">
                    <Sunset size={20} className="text-white" />
                 </div>
                 <div className="flex flex-col leading-none">
                    <span className="text-[10px] text-white/80 uppercase tracking-wider font-bold mb-1">Sunset</span>
                    <span className="text-lg font-bold tracking-wide">{weather?.sys?.sunset ? new Date(weather.sys.sunset * 1000).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit', hour12: false }) : "--:--"}</span>
                 </div>
               </div>
             </div>

            {/* Location & Time */}
            <div className="text-center animate-fade-in-up">
              <div className="flex items-center justify-center gap-2 text-white/90 mb-4 bg-white/10 w-fit mx-auto px-4 py-1.5 rounded-full backdrop-blur-sm border border-white/5">
                <MapPin size={16} />
                <span className="text-sm uppercase tracking-[0.2em] font-bold">{city}, {weather?.sys?.country}</span>
              </div>
              
              <div className="flex items-center justify-center gap-6 mb-6 group">
                 <button onClick={handlePrevCity} className="opacity-0 group-hover:opacity-100 transition-all duration-300 hover:scale-125 hover:bg-white/10 p-3 rounded-full active:scale-95 cursor-pointer">
                    <ChevronDown className="rotate-90 text-white" size={32} />
                 </button>
                 
                 <h2 className="text-5xl md:text-8xl font-black tracking-tighter drop-shadow-lg bg-clip-text text-transparent bg-gradient-to-b from-white to-white/70">
                    {weather?.name}
                 </h2>
                 <button onClick={toggleFavorite} className="hover:scale-110 transition active:scale-95 p-3 opacity-0 group-hover:opacity-100 duration-300">
                  <Heart 
                    size={32} 
                    className={isCurrentFavorite ? "fill-red-500 text-red-500 drop-shadow-md" : "text-white/60 hover:text-white"} 
                  />
                 </button>

                 <button onClick={handleNextCity} className="opacity-0 group-hover:opacity-100 transition-all duration-300 hover:scale-125 hover:bg-white/10 p-3 rounded-full active:scale-95 cursor-pointer">
                     <ChevronDown className="-rotate-90 text-white" size={32} />
                 </button>
              </div>
              
              <div className="transform scale-100 md:scale-125 origin-center mb-8">
                <DigitalClock />
              </div>
            </div>

            {/* Big Temp */}
            <div className="flex flex-col items-center animate-fade-in-up animation-delay-2000 relative">
               <h1 className="text-[140px] md:text-[200px] leading-tight font-extralight tracking-tighter drop-shadow-2xl text-white">
                  {weather?.main ? getTemp(weather.main.temp) : "--"}¬∞
               </h1>
               <div className="absolute -right-8 top-10 md:top-20 animate-bounce">
                  <div className="bg-white/20 backdrop-blur-lg p-4 rounded-3xl border border-white/20 shadow-xl flex flex-col items-center gap-1">
                      <Sun size={32} className="text-yellow-300 animate-spin-slow filter drop-shadow-lg" />
                      <span className="capitalize font-bold text-sm tracking-wide">{weather?.weather[0]?.main}</span>
                  </div>
               </div>
            </div>
          </div>

          <div className="relative z-30 w-full max-w-xl mx-auto mt-4 animate-fade-in-up animation-delay-4000">
             <form onSubmit={handleSearch} className="flex gap-4">
                <div className="relative flex-1 group">
                    <Search className="absolute left-6 top-1/2 -translate-y-1/2 text-white/60 group-focus-within:text-white transition-colors" size={20} />
                    <input 
                      type="text" 
                      value={city}
                      onChange={(e) => {
                        setCity(e.target.value);
                        isTyping.current = true;
                      }}
                      onFocus={() => {
                         if(city.length > 2 && suggestions.length > 0) setShowSuggestions(true);
                      }}
                      placeholder="Search city..." 
                      className="w-full bg-white/10 backdrop-blur-2xl border border-white/20 rounded-full py-4 pl-14 pr-6 text-white text-lg placeholder-white/50 outline-none focus:bg-white/20 focus:border-white/40 transition-all shadow-inner focus:ring-4 focus:ring-white/5"
                    />
                    {showSuggestions && suggestions.length > 0 && (
                      <div className="absolute top-full left-4 right-4 mt-2 bg-white/10 backdrop-blur-3xl border border-white/20 rounded-3xl overflow-hidden shadow-2xl z-50">
                        {suggestions.map((s, i) => (
                          <div 
                            key={i} 
                            onClick={() => handleSelectSuggestion(s)}
                            className="px-6 py-4 hover:bg-white/20 cursor-pointer flex justify-between items-center text-white border-b border-white/5 last:border-b-0 transition-colors"
                          >
                            <div className="flex items-center gap-3">
                                <div className="bg-white/10 p-1.5 rounded-full"><MapPin size={14} className="text-white" /></div>
                                <span className="font-medium">{s.name}</span>
                            </div>
                            <span className="text-[10px] text-white/80 bg-white/10 px-3 py-1 rounded-full uppercase tracking-wider font-bold">{s.state ? `${s.state}, ` : ''}{s.country}</span>
                          </div>
                        ))}
                      </div>
                    )}
                </div>
                <button 
                  type="button"
                  onClick={handleLocateMe}
                  className="bg-white/10 backdrop-blur-xl border border-white/20 hover:bg-white/20 text-white p-4 rounded-full transition-all hover:scale-105 active:scale-95 shadow-lg group"
                  title="Use my location"
                >
                   <LocateFixed size={24} className="group-hover:animate-pulse"/>
                </button>
             </form>
          </div>

          <div className="h-32 flex flex-col justify-end items-center pb-8 z-20 pointer-events-none">
             {/* Scroll Indicator */}
             <div className="flex flex-col items-center justify-center z-50 text-white/60 pointer-events-auto transition hover:text-white group" onClick={() => window.scrollTo({ top: window.innerHeight, behavior: 'smooth' })}>
                 <div className="w-[26px] h-[44px] rounded-full border-2 border-white/40 flex justify-center p-1.5 mb-2 shadow-[0_0_15px_rgba(255,255,255,0.2)] backdrop-blur-sm transition group-hover:border-white group-hover:scale-105 cursor-pointer">
                    <div className="w-1 h-1.5 bg-white rounded-full animate-scroll"></div>
                 </div>
                 <span className="text-[10px] uppercase tracking-[0.25em] font-semibold opacity-60 group-hover:opacity-100 transition-opacity">Explore</span>
             </div>
          </div>
        </div>

        <div className="bg-[#F6F6F8] w-full flex flex-col gap-10 rounded-t-[50px] -mt-16 md:-mt-20 relative z-30 pt-16 md:pt-20 pb-12 px-6 lg:px-20 shadow-[-20px_0_40px_rgba(0,0,0,0.1)]">
          
          <ScrollReveal>
             <div className="mb-4 text-center">
                 <h2 className="text-4xl md:text-5xl font-black text-slate-800 tracking-tight mb-3">
                   {user ? (
                     <>Welcome back, <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-500">{user.name}</span>!</>
                   ) : (
                     'Weather Details'
                   )}
                 </h2>
                <p className="text-slate-500 text-lg md:text-xl font-medium max-w-2xl mx-auto">
                  Your daily forecast, reimagined. Stay prepared and make every moment count with our precise weather updates.
                </p>
             </div>
          </ScrollReveal>

          <ScrollReveal>
          <div className="bg-white p-6 md:p-10 rounded-[40px] shadow-xl border border-slate-100">
            <div className="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
              <h3 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
                <div className="bg-blue-100 p-2 rounded-xl text-blue-500"><Thermometer size={24}/></div>
                Forecast Overview
              </h3>
              <div className="flex gap-4">
                 <button 
                   className="bg-slate-50 border border-slate-200 px-5 py-2.5 rounded-2xl text-sm font-bold text-slate-600 flex items-center gap-2 cursor-pointer hover:bg-white hover:border-blue-300 hover:text-blue-500 hover:shadow-md transition-all active:scale-95"
                   onClick={() => setChartType(chartType === 'temp' ? 'rain' : 'temp')}
                 >
                    {chartType === 'temp' ? "Temperature" : "Rain Chance"}
                    <div className={`w-2 h-2 rounded-full ${chartType === 'temp' ? 'bg-blue-500' : 'bg-green-500'}`}></div>
                 </button>
                <Link href="/forecast">
                  <div className="bg-slate-900 px-6 py-2.5 rounded-2xl text-white font-bold text-sm flex gap-3 items-center cursor-pointer hover:bg-blue-600 transition shadow-lg hover:shadow-blue-500/30 transform hover:-translate-y-1">
                    <span>Full Forecast</span> <ArrowRight size={16} />
                  </div>
                </Link>
              </div>
            </div>
            
            <div className="h-[300px] w-full">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart 
                  data={chartData} 
                  margin={{ top: 10, right: 10, left: 0, bottom: 0 }}
                >
                  <defs>
                    <linearGradient id="colorTemp" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor={chartType === 'temp' ? "#3B82F6" : "#10B981"} stopOpacity={0.4}/>
                      <stop offset="95%" stopColor={chartType === 'temp' ? "#3B82F6" : "#10B981"} stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0" />
                  <Tooltip 
                     contentStyle={{ 
                        borderRadius: '16px', 
                        border: 'none', 
                        boxShadow: '0 10px 25px rgba(0,0,0,0.1)',
                        padding: '12px 20px',
                        fontFamily: 'sans-serif'
                      }}
                     cursor={{ stroke: '#94A3B8', strokeWidth: 1, strokeDasharray: '4 4' }}
                  />
                  <Area 
                    type="monotone" 
                    dataKey={chartType === 'temp' ? "displayTemp" : "rainChance"} 
                    name={chartType === 'temp' ? "Temp" : "Chance of Rain"}
                    stroke={chartType === 'temp' ? "#3B82F6" : "#10B981"} 
                    strokeWidth={4} 
                    fill="url(#colorTemp)" 
                    animationDuration={1500}
                  />
                  <XAxis 
                    dataKey="time" 
                    axisLine={false} 
                    tickLine={false} 
                    tick={<CustomXAxisTick unit={unit} data={chartData} />} 
                    interval={0}
                    dy={15}
                  />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>
          </ScrollReveal>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <h3 className="text-2xl font-bold text-slate-800 md:col-span-3 mt-4 mb-2">Current Conditions</h3>
            
            <ScrollReveal className="md:col-span-1">
            <Tilt className="bg-white p-6 rounded-[35px] shadow-lg border border-slate-100 flex flex-col justify-between h-52 group hover:shadow-2xl transition-all duration-300">
              <div className="flex justify-between items-start">
                <div className="flex flex-col">
                   <span className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Humidity</span>
                   <span className="text-4xl font-black text-slate-800">{weather?.main?.humidity}%</span>
                </div>
                <div className="bg-blue-50 text-blue-500 p-3 rounded-2xl group-hover:bg-blue-500 group-hover:text-white transition-colors duration-300"><Droplets size={24}/></div>
              </div>
              
              <div className="mt-4">
                  <div className="flex justify-between text-[10px] text-slate-400 mb-2 font-semibold">
                      <span>Low</span>
                      <span>Mid</span>
                      <span>High</span>
                  </div>
                  <div className="w-full bg-slate-100 rounded-full h-3 relative overflow-hidden">
                    <div className="bg-gradient-to-r from-blue-300 to-blue-600 h-full rounded-full absolute top-0 left-0 transition-all duration-1000 ease-out" style={{ width: `${weather?.main?.humidity}%` }}></div>
                  </div>
                  <p className="mt-3 text-sm text-slate-500 font-medium">The dew point is {weather?.main?.temp_min}¬∞ right now.</p>
              </div>
            </Tilt>
            </ScrollReveal>

            <ScrollReveal className="md:col-span-1" delay={1}>
            <Tilt className="bg-white p-6 rounded-[35px] shadow-lg border border-slate-100 flex flex-col justify-between h-52 group hover:shadow-2xl transition-all duration-300">
              <div className="flex justify-between items-start">
                <div className="flex flex-col">
                   <span className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Wind Speed</span>
                   <span className="text-4xl font-black text-slate-800">{weather?.wind?.speed} <span className="text-lg text-slate-400 font-medium">km/h</span></span>
                </div>
                <div className="bg-teal-50 text-teal-500 p-3 rounded-2xl group-hover:bg-teal-500 group-hover:text-white transition-colors duration-300"><Wind size={24}/></div>
              </div>
              
              <div className="flex items-center justify-center mt-2 relative py-4">
                 <div className="flex items-center gap-4">
                    <div className="bg-slate-100 p-2 rounded-full transform" style={{ transform: `rotate(${weather?.wind?.deg}deg)` }}>
                       <ArrowRight size={20} className="text-slate-500" /> 
                    </div>
                    <span className="text-slate-600 font-bold text-lg">
                       {weather?.wind?.deg > 337.5 || weather?.wind?.deg <= 22.5 ? "North" :
                        weather?.wind?.deg > 22.5 && weather?.wind?.deg <= 67.5 ? "North East" :
                        weather?.wind?.deg > 67.5 && weather?.wind?.deg <= 112.5 ? "East" :
                        weather?.wind?.deg > 112.5 && weather?.wind?.deg <= 157.5 ? "South East" :
                        weather?.wind?.deg > 157.5 && weather?.wind?.deg <= 202.5 ? "South" :
                        weather?.wind?.deg > 202.5 && weather?.wind?.deg <= 247.5 ? "South West" :
                        weather?.wind?.deg > 247.5 && weather?.wind?.deg <= 292.5 ? "West" : "North West"}
                    </span>
                 </div>
              </div>
            </Tilt>
            </ScrollReveal>

            <ScrollReveal className="md:col-span-1" delay={2}>
            <Tilt className="bg-white p-6 rounded-[35px] shadow-lg border border-slate-100 flex flex-col justify-between h-52 group hover:shadow-2xl transition-all duration-300">
              <div className="flex justify-between items-start">
                <div className="flex flex-col">
                   <span className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Precipitation</span>
                   <span className="text-4xl font-black text-slate-800">{weather?.rain ? weather.rain['1h'] : (forecast[0]?.rain?.['3h'] || 0)} <span className="text-lg text-slate-400 font-medium">mm</span></span>
                </div>
                <div className="bg-indigo-50 text-indigo-500 p-3 rounded-2xl group-hover:bg-indigo-500 group-hover:text-white transition-colors duration-300"><CloudRain size={24}/></div>
              </div>

              <div className="flex justify-between items-end h-16 mt-4 gap-1.5">
                 {forecast.slice(0, 10).map((item, i) => {
                    const rainVol = item.rain && item.rain['3h'] ? item.rain['3h'] : 0;
                    const heightPercent = Math.min((rainVol / 5) * 100, 100) + 15;
                    return (
                        <div key={i} title={`${new Date(item.dt*1000).getHours()}:00 - ${rainVol}mm`} className={`w-full rounded-md transition-all duration-500 ${i === 0 ? 'bg-indigo-500' : 'bg-indigo-100'}`} style={{ height: `${heightPercent}%` }}></div>
                    );
                 })}
                 {forecast.length === 0 && <div className="text-xs text-gray-400 w-full text-center">No rain data</div>}
              </div>
            </Tilt>
            </ScrollReveal>

            <ScrollReveal className="md:col-span-1" delay={3}>
            <Tilt className="bg-white p-6 rounded-[35px] shadow-lg border border-slate-100 flex flex-col justify-between h-52 group hover:shadow-2xl transition-all duration-300">
              <div className="flex justify-between items-start">
                <div className="flex flex-col">
                   <span className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Air Quality</span>
                   <span className="text-4xl font-black text-slate-800">{weather?.aqi?.main?.aqi || '-'}</span>
                </div>
                <div className="bg-orange-50 text-orange-500 p-3 rounded-2xl group-hover:bg-orange-500 group-hover:text-white transition-colors duration-300"><CloudFog size={24}/></div>
              </div>
              
               <div className="mt-4">
                  <span className={`text-lg font-bold block mb-2 ${
                    weather?.aqi?.main?.aqi === 1 ? 'text-green-500' : 
                    weather?.aqi?.main?.aqi === 2 ? 'text-yellow-500' : 
                    weather?.aqi?.main?.aqi === 3 ? 'text-orange-500' : 
                    weather?.aqi?.main?.aqi === 4 ? 'text-red-500' : 'text-purple-600'
                 }`}>
                   {weather?.aqi?.main?.aqi === 1 ? 'Excellent Quality' : 
                    weather?.aqi?.main?.aqi === 2 ? 'Fair Quality' : 
                    weather?.aqi?.main?.aqi === 3 ? 'Moderate Pollution' : 
                    weather?.aqi?.main?.aqi === 4 ? 'Poor Quality' : 
                    weather?.aqi?.main?.aqi === 5 ? 'Very Poor' : 'Unknown'}
                 </span>
                  <div className="w-full bg-slate-100 rounded-full h-3 relative overflow-hidden">
                    <div className={`h-full rounded-full transition-all duration-1000 ${
                        !weather?.aqi?.main?.aqi ? 'bg-slate-200 w-0' :
                        weather?.aqi?.main?.aqi === 1 ? 'bg-green-500 w-[20%]' : 
                        weather?.aqi?.main?.aqi === 2 ? 'bg-yellow-500 w-[40%]' : 
                        weather?.aqi?.main?.aqi === 3 ? 'bg-orange-500 w-[60%]' : 
                        weather?.aqi?.main?.aqi === 4 ? 'bg-red-500 w-[80%]' : 'bg-purple-600 w-[100%]'
                    }`}></div>
                  </div>
              </div>
            </Tilt>
            </ScrollReveal>
            
            <ScrollReveal className="md:col-span-1" delay={4}>
            <Tilt className="bg-white p-6 rounded-[35px] shadow-lg border border-slate-100 flex flex-col justify-between h-52 group hover:shadow-2xl transition-all duration-300">
              <div className="flex justify-between items-start">
                <div className="flex flex-col">
                   <span className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Feels Like</span>
                   <span className="text-4xl font-black text-slate-800">{weather?.main ? getTemp(weather.main.feels_like) : "--"}¬∞</span>
                </div>
                <div className="bg-red-50 text-red-500 p-3 rounded-2xl group-hover:bg-red-500 group-hover:text-white transition-colors duration-300"><Thermometer size={24}/></div>
              </div>

               <div className="mt-4">
                  <div className="flex justify-between text-[10px] text-slate-400 mb-2 font-semibold">
                      <span>Cold</span>
                      <span>Comfortable</span>
                      <span>Hot</span>
                  </div>
                  <div className="w-full bg-slate-100 rounded-full h-3">
                     <div className="bg-gradient-to-r from-blue-400 via-green-400 to-red-500 h-full rounded-full" style={{ width: `${Math.min(weather?.main?.feels_like * 2, 100)}%` }}></div>
                  </div>
                  <p className="mt-3 text-sm text-slate-500">
                     {weather?.main?.feels_like > 30 ? "It feels quite hot." : weather?.main?.feels_like < 10 ? "It feels chilly." : "Comfortable temperature."}
                  </p>
              </div>
            </Tilt>
            </ScrollReveal>

             <ScrollReveal className="md:col-span-1" delay={5}>
             <Tilt className="bg-white p-6 rounded-[35px] shadow-lg border border-slate-100 flex flex-col justify-between h-52 group hover:shadow-2xl transition-all duration-300">
              <div className="flex justify-between items-start">
               <div className="flex flex-col">
                   <span className="text-slate-400 font-bold text-xs uppercase tracking-wider mb-1">Rain Probability</span>
                   <span className="text-4xl font-black text-slate-800">{forecast.length > 0 ? (forecast[0].pop || 0) * 100 : 0}%</span>
                </div>
                <div className="bg-cyan-50 text-cyan-500 p-3 rounded-2xl group-hover:bg-cyan-500 group-hover:text-white transition-colors duration-300"><Umbrella size={24}/></div>
              </div>
              
               <div className="mt-4">
                  <div className="flex justify-between text-[10px] text-slate-400 mb-2 font-semibold">
                      <span>Dry</span>
                      <span>Likely</span>
                      <span>Heavy</span>
                  </div>
                  <div className="w-full bg-slate-100 rounded-full h-3">
                     <div className="bg-cyan-500 h-full rounded-full transition-all duration-1000" style={{ width: `${forecast.length > 0 ? (forecast[0].pop || 0) * 100 : 0}%` }}></div>
                  </div>
                  <p className="mt-3 text-sm text-slate-500">
                    {(forecast[0]?.pop || 0) > 0.5 ? "Don't forget your umbrella!" : "Enjoy the dry weather."}
                  </p>
              </div>
            </Tilt>
            </ScrollReveal>

          </div>

          <ScrollReveal>
             <div className="rounded-[40px] overflow-hidden shadow-2xl border-4 border-white mt-4">
              {weather?.coord && (
                <WeatherMap lat={weather.coord.lat} lon={weather.coord.lon} />
              )}
             </div>
          </ScrollReveal>

        </div>
      </div>
      
      {showAuth && <AuthModal onClose={() => setShowAuth(false)} onLogin={(u) => { setUser(u); setShowAuth(false); }} />}
      {showProfile && user && (
          <ProfileModal 
            user={user} 
            onClose={() => setShowProfile(false)} 
            onUpdate={(u) => setUser(u)}
            onLogout={async () => {
                await axios.post('/api/auth/logout');
                setUser(null);
                setFavorites([]);
                setShowProfile(false);
            }} 
          />
      )}
    </div>
  );
}